name: CI/CD Pipeline - Fraud Detection

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  schedule:
    # Run tests daily at 2 AM UTC
    - cron: '0 2 * * *'

env:
  PYTHON_VERSION: '3.9'

jobs:
  test:
    name: Test & Lint
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install flake8 black
    
    - name: Lint with flake8
      run: |
        # Stop build if there are Python syntax errors
        flake8 src/ --count --select=E9,F63,F7,F82 --show-source --statistics
        # Treat all errors as warnings
        flake8 src/ --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics
    
    - name: Format check with black
      run: |
        black --check src/
    
    - name: Run unit tests
      run: |
        pytest tests/ -v --cov=src --cov-report=term-missing --cov-report=xml
    
    - name: Upload coverage reports
      uses: codecov/codecov-action@v3
      with:
        files: ./coverage.xml
        flags: unittests
        name: codecov-umbrella

  integration-test:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: test
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
    
    - name: Install dependencies
      run: |
        pip install -r requirements.txt
    
    - name: Start API server
      run: |
        python src/main.py &
        sleep 10
    
    - name: Test API endpoints
      run: |
        python src/test_api.py

  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: [test, integration-test]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Deploy to Render
      env:
        RENDER_DEPLOY_HOOK: ${{ secrets.RENDER_DEPLOY_HOOK }}
      run: |
        curl -X POST $RENDER_DEPLOY_HOOK
    
    - name: Wait for deployment
      run: sleep 60
    
    - name: Verify deployment
      run: |
        RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" https://fraud-detection-api-xxxx.onrender.com/health)
        if [ $RESPONSE -eq 200 ]; then
          echo "✅ Deployment successful!"
        else
          echo "❌ Deployment failed with status $RESPONSE"
          exit 1
        fi
    
    - name: Send notification
      if: always()
      run: |
        echo "Deployment completed. Status: ${{ job.status }}"

  performance-test:
    name: Performance Testing
    runs-on: ubuntu-latest
    needs: deploy
    if: github.ref == 'refs/heads/main'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
    
    - name: Install dependencies
      run: |
        pip install requests numpy
    
    - name: Run load test
      run: |
        python -c "
import requests
import numpy as np
import time

BASE_URL = 'https://fraud-detection-api-xxxx.onrender.com'
latencies = []

for i in range(50):
    transaction = {'features': np.random.randn(40).tolist()}
    start = time.time()
    r = requests.post(f'{BASE_URL}/predict', json=transaction)
    latencies.append((time.time() - start) * 1000)

print(f'Average latency: {np.mean(latencies):.2f}ms')
print(f'P95 latency: {np.percentile(latencies, 95):.2f}ms')

if np.mean(latencies) > 500:
    print('❌ Performance degraded!')
    exit(1)
else:
    print('✅ Performance acceptable')
        "